{{- /*
ConfigMap renders the application config.yaml.
If .Values.configRaw is provided, it will be rendered verbatim (and templated with tpl).
Otherwise, it will be constructed from structured values.
*/ -}}
{{- if and (not .Values.existingConfigSecret) (not .Values.configAsSecret) }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "gostwriter.fullname" . }}-config
  labels:
    {{- include "gostwriter.labels" . | nindent 4 }}
data:
  config.yaml: |
    {{- if .Values.configRaw }}
    {{- tpl .Values.configRaw . | nindent 4 }}
    {{- else }}
    server:
      address: {{ .Values.server.address | quote }}
      readTimeout: {{ .Values.server.readTimeout }}
      writeTimeout: {{ .Values.server.writeTimeout }}
      idleTimeout: {{ .Values.server.idleTimeout }}
      maxUploadSize: {{ .Values.server.maxUploadSize }}
      workerCount: {{ .Values.server.workerCount }}
      storageDir: {{ .Values.server.storageDir | quote }}
      apiKey: {{ .Values.server.apiKey | quote }}
      databasePath: {{ .Values.server.databasePath | quote }}
      shutdownGrace: {{ .Values.server.shutdownGrace }}
      callbackRetries: {{ .Values.server.callbackRetries }}
      callbackBackoff: {{ .Values.server.callbackBackoff }}
    llm:
      provider: {{ .Values.llm.provider | quote }}
      mock:
        delay: {{ .Values.llm.mock.delay }}
        prefix: {{ .Values.llm.mock.prefix | quote }}
      aiproxy:
        baseUrl: {{ .Values.llm.aiproxy.baseUrl | quote }}
        apiKey: {{ .Values.llm.aiproxy.apiKey | quote }}
        model: {{ .Values.llm.aiproxy.model | quote }}
        systemPrompt: {{ .Values.llm.aiproxy.systemPrompt | quote }}
        instructions: {{ .Values.llm.aiproxy.instructions | quote }}
        temperature: {{ .Values.llm.aiproxy.temperature }}
        maxTokens: {{ .Values.llm.aiproxy.maxTokens }}
    target:
      type: {{ .Values.target.type | quote }}
      name: {{ .Values.target.name | quote }}
      repoUrl: {{ .Values.target.repoUrl | quote }}
      branch: {{ .Values.target.branch | quote }}
      basePath: {{ .Values.target.basePath | quote }}
      filenameTemplate: {{ .Values.target.filenameTemplate | squote }}
      commitMessageTemplate: {{ .Values.target.commitMessageTemplate | quote }}
      authorName: {{ .Values.target.authorName | quote }}
      authorEmail: {{ .Values.target.authorEmail | quote }}
      cloneCacheDir: {{ .Values.target.cloneCacheDir | quote }}
      auth:
        type: {{ .Values.target.auth.type | quote }}
        username: {{ .Values.target.auth.username | quote }}
        token: {{ .Values.target.auth.token | quote }}
    {{- end }}
{{- end }}
